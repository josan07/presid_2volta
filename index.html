<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador 2ª Volta - Presidenciais</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .slider { -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #d3d3d3; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #4f46e5; cursor: pointer; border: 2px solid white; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <div id="winner-container" class="w-full py-6 text-center shadow-lg mb-4 transition-colors duration-500">
        <h1 id="winner-text" class="text-4xl font-black uppercase tracking-widest text-white">A calcular...</h1>
    </div>

    <div class="sticky top-0 z-50 bg-white shadow-md p-4 mb-8">
        <div class="max-w-6xl mx-auto flex flex-wrap justify-around items-center gap-4">
            <div class="text-center">
                <p class="text-xs font-bold uppercase text-gray-400">António José Seguro</p>
                <p id="res-seguro" class="text-3xl font-black text-pink-500">0%</p>
                <p id="votos-seguro" class="text-[10px] text-gray-400 uppercase">0 votos</p>
            </div>
            
            <div class="text-center">
                <p class="text-xs font-bold uppercase text-gray-400">André Ventura</p>
                <p id="res-ventura" class="text-3xl font-black text-black">0%</p>
                <p id="votos-ventura" class="text-[10px] text-gray-400 uppercase">0 votos</p>
            </div>

            <div class="h-12 w-px bg-gray-200 hidden md:block"></div>

            <div class="text-center">
                <p class="text-xs font-bold uppercase text-gray-400">Abstenção Total 2ªV</p>
                <p id="res-abstencao" class="text-3xl font-black text-gray-500">0%</p>
                <p id="votos-abstencao" class="text-[10px] text-gray-400 uppercase">0 eleitores</p>
            </div>
        </div>
    </div>

    <main class="max-w-6xl mx-auto px-4 pb-20">
        
        <div class="mb-10 bg-slate-200 p-6 rounded-2xl border-2 border-slate-300">
            <h2 class="text-sm font-bold uppercase text-slate-500 mb-4 flex items-center italic">
                <span class="mr-2">➔</span> Mobilização de Abstencionistas (Quem não votou na 1ª Volta)
            </h2>
            <div id="abstention-control-root"></div>
        </div>

        <h2 class="text-lg font-bold mb-6 text-gray-700 uppercase tracking-tight">Transferência de Votos dos Candidatos</h2>
        <div id="controls-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

        <div class="mt-12 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h2 class="text-xl font-bold mb-4">Fluxo de Votos Simplificado</h2>
            <p class="text-xs text-gray-400 mb-4">* Candidatos com menos de 5% de votos na 1ª volta foram agrupados em "Outros" para melhor visibilidade.</p>
            <div id="sankey-chart" style="width:100%; height:600px;"></div>
        </div>
    </main>

    <script>
        const inscritosTotais = 11018835;
        const totalVotosValidos1V = 5640503;

        // Configuração dos Candidatos e Defaults
        const candidatos = [
            { id: 'seguro', nome: 'A. J. Seguro', votos: 1754919, cor: '#FFB6C1', defVent: 0, defAbst: 0 },
            { id: 'ventura', nome: 'André Ventura', votos: 1326657, cor: '#1a1a1a', defVent: 100, defAbst: 0 },
            { id: 'cotrim', nome: 'Cotrim Figueiredo', votos: 902591, cor: '#87CEEB', defVent: 50, defAbst: 0 },
            { id: 'gouveia', nome: 'Gouveia e Melo', votos: 695093, cor: '#4B5320', defVent: 50, defAbst: 0 },
            { id: 'mendes', nome: 'Marques Mendes', votos: 637399, cor: '#FF8C00', defVent: 50, defAbst: 0 },
            { id: 'catarina', nome: 'Catarina Martins', votos: 116305, cor: '#8B0000', defVent: 50, defAbst: 0 },
            { id: 'filipe', nome: 'António Filipe', votos: 92589, cor: '#FF0000', defVent: 50, defAbst: 0 },
            { id: 'vieira', nome: 'Manuel J. Vieira', votos: 60899, cor: '#EAB308', defVent: 50, defAbst: 0 },
            { id: 'pinto', nome: 'Jorge Pinto', votos: 38536, cor: '#22C55E', defVent: 50, defAbst: 0 },
            { id: 'pestana', nome: 'André Pestana', votos: 10893, cor: '#DC143C', defVent: 50, defAbst: 0 },
            { id: 'correia', nome: 'Humberto Correia', votos: 4622, cor: '#808080', defVent: 50, defAbst: 0 },
            { id: 'abstencao1', nome: 'Abstenção 1ª Volta', votos: 5378332, cor: '#94a3b8', defVent: 50, defAbst: 100, isAbst: true }
        ];

        let state = {};
        candidatos.forEach(c => {
            state[c.id] = { abstencao: c.defAbst, ventura: c.defVent };
        });

        function createCardHTML(c) {
            return `
                <div class="bg-white p-4 rounded-lg shadow-sm border-t-4" style="border-top-color: ${c.cor}">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-gray-800">${c.nome}</span>
                        <span class="text-[10px] text-gray-400 bg-gray-50 px-2 py-1 rounded border">${c.votos.toLocaleString()} votos</span>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-[10px] font-bold text-gray-500 mb-1">
                                <span>VOTANTES: <span id="perc-vota-${c.id}">0</span>%</span>
                                <span>ABSTENÇÃO: <span id="perc-abst-${c.id}">0</span>%</span>
                            </div>
                            <input type="range" class="slider" value="${100 - state[c.id].abstencao}" oninput="updateState('${c.id}', 'abstencao', 100 - this.value)">
                        </div>
                        <div>
                            <div class="flex justify-between text-[10px] font-bold mb-1">
                                <span class="text-pink-500">SEGURO: <span id="perc-seguro-${c.id}">0</span>%</span>
                                <span class="text-black">VENTURA: <span id="perc-ventura-${c.id}">0</span>%</span>
                            </div>
                            <input type="range" class="slider" style="background: linear-gradient(to right, #FFB6C1, #000)" value="${state[c.id].ventura}" oninput="updateState('${c.id}', 'ventura', this.value)">
                        </div>
                    </div>
                </div>
            `;
        }

        function initUI() {
            const grid = document.getElementById('controls-grid');
            const abstRoot = document.getElementById('abstention-control-root');
            
            candidatos.forEach(c => {
                if (c.isAbst) {
                    abstRoot.innerHTML = createCardHTML(c);
                } else {
                    grid.innerHTML += createCardHTML(c);
                }
            });
            calculateResults();
        }

        window.updateState = (id, field, value) => {
            state[id][field] = parseFloat(value);
            calculateResults();
        };

        function calculateResults() {
            let totalSeguro = 0, totalVentura = 0, totalAbstencao2V = 0;
            
            let majorCandidates = candidatos.filter(c => (c.votos / totalVotosValidos1V >= 0.05) || c.isAbst);
            let minorCandidates = candidatos.filter(c => (c.votos / totalVotosValidos1V < 0.05) && !c.isAbst);

            let flowData = {
                labels: [], sources: [], targets: [], values: [], colors: [], linkColors: []
            };

            majorCandidates.forEach(c => flowData.labels.push(c.nome));
            flowData.labels.push("Outros (<5%)");
            const idxSeguro = flowData.labels.length; flowData.labels.push("A. J. Seguro");
            const idxVentura = flowData.labels.length; flowData.labels.push("André Ventura");
            const idxAbst = flowData.labels.length; flowData.labels.push("Abstenção 2ªV");

            majorCandidates.forEach((c, idx) => {
                const s = state[c.id];
                const v_abst = (s.abstencao / 100) * c.votos;
                const v_vota = c.votos - v_abst;
                const v_vent = (s.ventura / 100) * v_vota;
                const v_seg = v_vota - v_vent;

                totalSeguro += v_seg; totalVentura += v_vent; totalAbstencao2V += v_abst;
                updateLabels(c.id, s);

                addFlow(flowData, idx, idxSeguro, v_seg, c.cor);
                addFlow(flowData, idx, idxVentura, v_vent, c.cor);
                addFlow(flowData, idx, idxAbst, v_abst, c.cor);
            });

            let outSeg = 0, outVent = 0, outAbst = 0;
            const idxOutros = majorCandidates.length;
            
            minorCandidates.forEach(c => {
                const s = state[c.id];
                const v_abst = (s.abstencao / 100) * c.votos;
                const v_vota = c.votos - v_abst;
                const v_vent = (s.ventura / 100) * v_vota;
                const v_seg = v_vota - v_vent;
                
                outSeg += v_seg; outVent += v_vent; outAbst += v_abst;
                totalSeguro += v_seg; totalVentura += v_vent; totalAbstencao2V += v_abst;
                updateLabels(c.id, s);
            });

            addFlow(flowData, idxOutros, idxSeguro, outSeg, '#94a3b8');
            addFlow(flowData, idxOutros, idxVentura, outVent, '#94a3b8');
            addFlow(flowData, idxOutros, idxAbst, outAbst, '#94a3b8');

            // --- ATUALIZAÇÃO DOS RESULTADOS NO CABEÇALHO ---
            const totalVotosValidos = totalSeguro + totalVentura;
            const percSeg = (totalSeguro / totalVotosValidos) * 100;
            const percVent = (totalVentura / totalVotosValidos) * 100;
            const percAbst = (totalAbstencao2V / inscritosTotais) * 100;

            document.getElementById('res-seguro').innerText = `${percSeg.toFixed(2)}%`;
            document.getElementById('votos-seguro').innerText = `${Math.round(totalSeguro).toLocaleString()} votos`;
            
            document.getElementById('res-ventura').innerText = `${percVent.toFixed(2)}%`;
            document.getElementById('votos-ventura').innerText = `${Math.round(totalVentura).toLocaleString()} votos`;
            
            document.getElementById('res-abstencao').innerText = `${percAbst.toFixed(2)}%`;
            document.getElementById('votos-abstencao').innerText = `${Math.round(totalAbstencao2V).toLocaleString()} eleitores`;

            // Banner Superior
            const winText = document.getElementById('winner-text');
            const winCont = document.getElementById('winner-container');
            if (percSeg > percVent) {
                winText.innerText = `Seguro vence com ${percSeg.toFixed(1)}%`;
                winCont.className = "w-full py-6 text-center shadow-lg mb-4 bg-pink-500 transition-colors duration-500";
            } else {
                winText.innerText = `Ventura vence com ${percVent.toFixed(1)}%`;
                winCont.className = "w-full py-6 text-center shadow-lg mb-4 bg-black transition-colors duration-500";
            }

            drawSankey(flowData, [...majorCandidates.map(c => c.cor), '#94a3b8', '#F472B6', '#1a1a1a', '#cbd5e1']);
        }

        function addFlow(data, src, tar, val, col) {
            if (val > 0) {
                data.sources.push(src); data.targets.push(tar); data.values.push(val);
                data.linkColors.push(col + '66'); // 66 = transparência
            }
        }

        function updateLabels(id, s) {
            document.getElementById(`perc-abst-${id}`).innerText = Math.round(s.abstencao);
            document.getElementById(`perc-vota-${id}`).innerText = Math.round(100 - s.abstencao);
            document.getElementById(`perc-seguro-${id}`).innerText = Math.round(100 - s.ventura);
            document.getElementById(`perc-ventura-${id}`).innerText = Math.round(s.ventura);
        }

        function drawSankey(data, nodeCols) {
            const trace = {
                type: "sankey", orientation: "h",
                node: { 
                    pad: 15, 
                    thickness: 20, 
                    line: { color: "black", width: 0.5 },
                    label: data.labels, 
                    color: nodeCols 
                },
                link: { 
                    source: data.sources, 
                    target: data.targets, 
                    value: data.values, 
                    color: data.linkColors 
                }
            };
            Plotly.newPlot('sankey-chart', [trace], { 
                margin: { l: 0, r: 0, t: 20, b: 20 },
                font: { size: 10 }
            }, { responsive: true });
        }

        initUI();
    </script>
</body>
</html>
