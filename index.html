<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador 2ª Volta - Presidenciais</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .slider { -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: #d3d3d3; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #4f46e5; cursor: pointer; border: 2px solid white; }
        .winner-banner { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <div id="winner-container" class="winner-banner w-full py-6 text-center shadow-lg mb-4">
        <h1 id="winner-text" class="text-4xl font-black uppercase tracking-widest text-white">A calcular resultados...</h1>
    </div>

    <div class="sticky top-0 z-50 bg-white shadow-md p-4 mb-8">
        <div class="max-w-6xl mx-auto flex flex-wrap justify-around items-center gap-4">
            <div class="text-center">
                <p class="text-sm font-bold uppercase text-gray-500">António José Seguro</p>
                <p id="res-seguro" class="text-3xl font-black text-pink-500">0%</p>
                <p id="votos-seguro" class="text-xs text-gray-400">0 votos</p>
            </div>
            <div class="h-12 w-px bg-gray-200 hidden md:block"></div>
            <div class="text-center">
                <p class="text-sm font-bold uppercase text-gray-500">André Ventura</p>
                <p id="res-ventura" class="text-3xl font-black text-black">0%</p>
                <p id="votos-ventura" class="text-xs text-gray-400">0 votos</p>
            </div>
            <div class="h-12 w-px bg-gray-200 hidden md:block"></div>
            <div class="text-center">
                <p class="text-sm font-bold uppercase text-gray-500">Abstenção Total (2ªV)</p>
                <p id="res-abstencao" class="text-3xl font-black text-gray-400">0%</p>
            </div>
        </div>
    </div>

    <main class="max-w-6xl mx-auto px-4 pb-20">
        <h2 class="text-xl font-semibold mb-6 text-center text-gray-600">Ajuste a transferência de voto de cada candidato</h2>
        
        <div id="controls-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>

        <div class="mt-12 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h2 class="text-xl font-bold mb-4">Fluxo de Votos (Sankey)</h2>
            <div id="sankey-chart" style="width:100%; height:600px;"></div>
        </div>
    </main>

    <script>
        const inscritosTotais = 11018835;

        // Dados da 1ª Volta (Ordenados por relevância)
        let candidatos = [
            { id: 'seguro', nome: 'A. J. Seguro', votos: 1754919, cor: '#FFB6C1', defaultVentura: 0, defaultAbst: 0 },
            { id: 'ventura', nome: 'André Ventura', votos: 1326657, cor: '#1a1a1a', defaultVentura: 100, defaultAbst: 0 },
            { id: 'cotrim', nome: 'Cotrim Figueiredo', votos: 902591, cor: '#87CEEB', defaultVentura: 50, defaultAbst: 15 },
            { id: 'gouveia', nome: 'Gouveia e Melo', votos: 695093, cor: '#4B5320', defaultVentura: 50, defaultAbst: 20 },
            { id: 'mendes', nome: 'Marques Mendes', votos: 637399, cor: '#FF8C00', defaultVentura: 40, defaultAbst: 20 },
            { id: 'catarina', nome: 'Catarina Martins', votos: 116305, cor: '#8B0000', defaultVentura: 5, defaultAbst: 30 },
            { id: 'filipe', nome: 'António Filipe', votos: 92589, cor: '#FF0000', defaultVentura: 5, defaultAbst: 35 },
            { id: 'vieira', nome: 'Manuel J. Vieira', votos: 60899, cor: '#EAB308', defaultVentura: 50, defaultAbst: 40 },
            { id: 'pinto', nome: 'Jorge Pinto', votos: 38536, cor: '#22C55E', defaultVentura: 10, defaultAbst: 30 },
            { id: 'pestana', nome: 'André Pestana', votos: 10893, cor: '#DC143C', defaultVentura: 15, defaultAbst: 40 },
            { id: 'correia', nome: 'Humberto Correia', votos: 4622, cor: '#808080', defaultVentura: 50, defaultAbst: 50 },
            { id: 'abstencao1', nome: 'Abst./Brancos/Nulos 1ªV', votos: 5378332, cor: '#D1D5DB', defaultVentura: 50, defaultAbst: 90 }
        ];

        // Ordenar por votos
        candidatos.sort((a, b) => b.votos - a.votos);

        let state = {};
        candidatos.forEach(c => {
            state[c.id] = {
                abstencao: c.defaultAbst,
                ventura: c.defaultVentura // 0 = 100% Seguro, 100 = 100% Ventura
            };
        });

        function initUI() {
            const grid = document.getElementById('controls-grid');
            candidatos.forEach(c => {
                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-lg shadow-sm border-t-4";
                card.style.borderColor = c.cor;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-gray-800">${c.nome}</h3>
                        <span class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500">${c.votos.toLocaleString()} votos</span>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-[10px] uppercase font-bold text-gray-400 mb-1">
                            <span>Vota 2ªV: <span id="perc-vota-${c.id}">0</span>%</span>
                            <span>Abstenção: <span id="perc-abst-${c.id}">0</span>%</span>
                        </div>
                        <input type="range" class="slider w-full" 
                            value="${100 - state[c.id].abstencao}" 
                            oninput="updateState('${c.id}', 'abstencao', 100 - this.value)">
                    </div>

                    <div>
                        <div class="flex justify-between text-[10px] uppercase font-bold mb-1">
                            <span class="text-pink-500">Seguro: <span id="perc-seguro-${c.id}">0</span>%</span>
                            <span class="text-black">Ventura: <span id="perc-ventura-${c.id}">0</span>%</span>
                        </div>
                        <input type="range" class="slider w-full" 
                            style="background: linear-gradient(to right, #FFB6C1, #000)"
                            value="${state[c.id].ventura}" 
                            oninput="updateState('${c.id}', 'ventura', this.value)">
                    </div>
                `;
                grid.appendChild(card);
            });
            calculateResults();
        }

        window.updateState = (id, field, value) => {
            state[id][field] = parseFloat(value);
            calculateResults();
        };

        function calculateResults() {
            let totalSeguro = 0;
            let totalVentura = 0;
            let totalAbstencao2V = 0;

            const sankeyData = {
                labels: [...candidatos.map(c => c.nome), "A. J. Seguro", "André Ventura", "Abstenção 2ªV"],
                sources: [],
                targets: [],
                values: [],
                nodeColors: [...candidatos.map(c => c.cor), "#F472B6", "#1a1a1a", "#9CA3AF"],
                linkColors: []
            };

            candidatos.forEach((c, index) => {
                const s = state[c.id];
                const v_abstencao = (s.abstencao / 100) * c.votos;
                const v_restantes = c.votos - v_abstencao;
                const v_ventura = (s.ventura / 100) * v_restantes;
                const v_seguro = v_restantes - v_ventura;

                totalSeguro += v_seguro;
                totalVentura += v_ventura;
                totalAbstencao2V += v_abstencao;

                // Atualizar labels de percentagem no UI
                document.getElementById(`perc-abst-${c.id}`).innerText = Math.round(s.abstencao);
                document.getElementById(`perc-vota-${c.id}`).innerText = Math.round(100 - s.abstencao);
                document.getElementById(`perc-seguro-${c.id}`).innerText = Math.round(100 - s.ventura);
                document.getElementById(`perc-ventura-${c.id}`).innerText = Math.round(s.ventura);

                const baseIdx = candidatos.length;
                const linkAlpha = "88"; // Hex para transparência

                if (v_seguro > 0) {
                    sankeyData.sources.push(index);
                    sankeyData.targets.push(baseIdx);
                    sankeyData.values.push(v_seguro);
                    sankeyData.linkColors.push(c.cor + linkAlpha);
                }
                if (v_ventura > 0) {
                    sankeyData.sources.push(index);
                    sankeyData.targets.push(baseIdx + 1);
                    sankeyData.values.push(v_ventura);
                    sankeyData.linkColors.push(c.cor + linkAlpha);
                }
                if (v_abstencao > 0) {
                    sankeyData.sources.push(index);
                    sankeyData.targets.push(baseIdx + 2);
                    sankeyData.values.push(v_abstencao);
                    sankeyData.linkColors.push(c.cor + linkAlpha);
                }
            });

            const totalVotosValidos = totalSeguro + totalVentura;
            const percSeguro = (totalSeguro / totalVotosValidos) * 100;
            const percVentura = (totalVentura / totalVotosValidos) * 100;
            const percAbst2V = (totalAbstencao2V / inscritosTotais) * 100;

            // Atualizar Totais
            document.getElementById('res-seguro').innerText = `${percSeguro.toFixed(2)}%`;
            document.getElementById('votos-seguro').innerText = `${Math.round(totalSeguro).toLocaleString()} votos`;
            document.getElementById('res-ventura').innerText = `${percVentura.toFixed(2)}%`;
            document.getElementById('votos-ventura').innerText = `${Math.round(totalVentura).toLocaleString()} votos`;
            document.getElementById('res-abstencao').innerText = `${percAbst2V.toFixed(2)}%`;

            // Atualizar Banner do Vencedor
            const winText = document.getElementById('winner-text');
            const winCont = document.getElementById('winner-container');
            if (percSeguro > percVentura) {
                winText.innerText = `António José Seguro vence (${percSeguro.toFixed(1)}%)`;
                winCont.className = "winner-banner w-full py-6 text-center shadow-lg mb-4 bg-pink-500";
            } else {
                winText.innerText = `André Ventura vence (${percVentura.toFixed(1)}%)`;
                winCont.className = "winner-banner w-full py-6 text-center shadow-lg mb-4 bg-black";
            }

            drawSankey(sankeyData);
        }

        function drawSankey(data) {
            const trace = {
                type: "sankey",
                orientation: "h",
                node: {
                    pad: 15,
                    thickness: 30,
                    line: { color: "black", width: 0.5 },
                    label: data.labels,
                    color: data.nodeColors
                },
                link: {
                    source: data.sources,
                    target: data.targets,
                    value: data.values,
                    color: data.linkColors
                }
            };

            const layout = {
                font: { size: 11 },
                margin: { l: 0, r: 0, t: 30, b: 30 }
            };

            Plotly.newPlot('sankey-chart', [trace], layout, {responsive: true});
        }

        initUI();
    </script>
</body>
</html>
